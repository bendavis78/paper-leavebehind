<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">

<!--
Material Design: [List Controls](http://www.google.com/design/spec/components/lists-controls.html#lists-controls-types-of-list-controls)

A leave-behind is an informative hint as to what swiping a list item away will do to that item.

TODO: docs

@element paper-leavebehind
@blurb 
@homepage http://bendavis78.github.io/paper-leavebehind/
@demo demo/index.html
-->
<dom-module id="paper-leavebehind">
  <template>
    <style>
      :host {
        display: block;
        border-bottom: 1px solid var(--paper-leavebehind-divider-color, --divider-color);
        cursor: default;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        @apply(--paper-leavebehind-content);
      }
      #content {
        background: var(--paper-leavebehind-background, --primary-background-color);
        @apply(--paper-leavebehind-content);
        display: block;
        z-index: 3;
        position: relative;
      }
      #content:not(.dragging) {
        transition: transform 500ms cubic-bezier(0.4, 0, 0.2, 1); 
        -webkit-animation-fill-mode: both;
        animation-fill-mode: both;
      }
      #ripple {
        pointer-events: none;
      }
      .container {
        z-index: 0;
        padding: 0;
        overflow: hidden;
        background: #e0e0e0;
        position: relative;
      }
      .icon {
        color: var(--paper-leavebehind-icon-color, --primary-text-color);
        @apply(--paper-leavebehind-icon);
      }
      .leavebehind-content-container, .leavebehind-icons {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 1;
        left: 0;
      }
      .top, .bottom {
        pointer-events: none;
        position: absolute;
        height: 100%;
        width: 100%;
        left: 0;
        z-index: 2;
      }
      .top {
        top: -100%;
      }
      .bottom {
        bottom: -100%;
      }
    </style>

    <div class="container">
      <div class="leavebehind-content-container">
        <content select=".leavebehind-content"></content>
      </div>
      <div class="leavebehind-icons layout horizontal">
        <iron-icon icon="[[icon]]" class="icon layout self-start"></iron-icon>
        <iron-icon icon="[[icon]]" class="icon layout self-end"></iron-icon>
      </div>
      <paper-material elevation="[[elevation]]" class="top"></paper-material>
      <paper-material elevation="[[elevation]]" class="bottom"></paper-material>
      <paper-material id="content" elevation="[[elevation]]" on-track="_track" 
        class$="{{_contentClass(_dragging)}}">
        <content select=":not(.leavebehind-content)"></content>
      </paper-material>
    </div>

  </template>
  <script>
  (function() {
    // TODO move approppriate methods to iron-swipable-behavior
    Polymer({
      is: 'paper-leavebehind',
      properties: {
        icon: {
          type: String,
          value: null
        },
        disabled: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
      },
      _track: function(event) {
        var state = event.detail.state;
        if (state === 'start') {
          // TODO slight ripple when starting swipe
          this.set('_dragging', true);
          this._dragStart = event.detail.x;
          this._contentLeft = this.$.content.offsetLeft;
          this._contentWidth = this.$.content.offsetWidth;
        }
        if (state === 'end') {
          this.set('_dragging', false);
          this.transform('translateX(' + this._contentLeft + 'px)', this.$.content);
        }
        if (state === 'track') {
          window.requestAnimationFrame(function() {
            var x = (event.detail.x - this._dragStart);
            if (this.disabled) {
              // add "resistence" easing;
              var max = 64;
              var p = x > this._contentWidth ? 1 : x / this._contentWidth;
              x = max * (1 - Math.pow(1 - p, 2));
            }
            this.transform('translateX(' + x + 'px)', this.$.content);
          }.bind(this));
        }
      },
      _contentClass() {
        if (this._dragging) {
          return 'dragging';
        }
        return '';
      }
    });
  })();
  </script>

</dom-module>
